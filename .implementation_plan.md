# Implementation Plan: Subject-Specific Data Isolation

## Goal
Separate attendance data, grades, and seat positions by subject so each subject has independent data.

## Status: PARTIALLY COMPLETE
⚠️ **Important**: This is a major structural change. Current implementation covers attendance isolation.
Seat position isolation requires careful data migration to avoid breaking existing data.

## Changes Completed ✅

### 1. Storage Layer (storage.js)
- ✅ Added `subjectId` parameter to `getAttendanceSessions(classId, subjectId)`
- ✅ Added `subjectId` parameter to `addAttendanceSession(classId, subjectId)`  
- ✅ Sessions now store: `{ id, classId, subjectId, date }`

### 2. Attendance Creation (app.js)
- ✅ Updated `addAttendanceColumn()` to require subject selection
- ✅ Pass `currentSubjectId` when creating new attendance sessions
- ✅ Shows alert if no subject selected

### 3. Attendance Display (app.js)
- ✅ Updated `loadStudentsList()` to filter sessions by `currentSubjectId`
- ✅ Only shows attendance columns for the selected subject
- ✅ Each subject has independent attendance data

## Remaining Work (Seat Positions & Grid Settings)

### Current Issues
1. **Seat positions are shared** across all subjects
   - Current: `student.seat = 5` (single number)
   - Needed: `student.seatPositions = { 'subjectId1': 5, 'subjectId2': 12 }`

2. **Grid settings are shared** across all subjects
   - Current: One setting per user
   - Needed: One setting per subject

### Required Changes for Complete Implementation

#### A. Modify Student Data Structure
```javascript
// OLD structure
{
  id: 'HS001',
  seat: 5,  // Single position
  ...
}

// NEW structure (needed)
{
  id: 'HS001',
  seat: 5,  // Keep for backward compatibility
  seatPositions: {
    'subject1_id': 5,
    'subject2_id': 12,
    'subject3_id': null  // Not assigned
  }
  ...
}
```

#### B. Update Classroom Rendering (classroom.js)
**File**: `classroom.js`
**Function**: `renderClassroom()`
- Line 41: Change from `s.seat` to `s.seatPositions[currentSubjectId]`
- Add migration logic to convert old `seat` to `seatPositions`

#### C. Update Seat Assignment (classroom.js)  
**File**: `classroom.js`
**Function**: `assignSeat()`
- Update to save to `student.seatPositions[currentSubjectId]`
- Ensure subject ID is available in context

#### D. Grid Settings Per Subject (storage.js)
**File**: `storage.js`
**Functions to modify**:
```javascript
// Change from:
getGridSettings() { ... }
saveGridSettings(settings) { ... }

// To:
getGridSettings(subjectId) { 
  // Return subject-specific settings
  // Fall back to default if not found
}
saveGridSettings(subjectId, settings) {
  // Save per subject
}
```

#### E. Update All Grid Settings Calls
Files affected:
- `app.js` - gridSettingsBtn click handler
- `app.js` - gridSettingsForm submit
- `classroom.js` - renderClassroom()
- `app.js` - migration script on login

### Data Migration Strategy

**Option 1: Automatic Migration** (Recommended)
- On login, check if students have old `seat` structure
- Convert `seat` → `seatPositions` with current subject
- Preserve old `seat` value for backward compatibility

**Option 2: Manual Reset**
- User must rearrange seats for each subject
- Simpler but more work for users

### Testing Checklist
- [ ] Create class with subject A, add students, arrange seats
- [ ] Switch to subject B, verify seats are empty/different
- [ ] Create attendance in subject A
- [ ] Switch to subject B, verify no attendance columns
- [ ] Change grid size in subject A
- [ ] Switch to subject B, verify different grid size
- [ ] Test data export/import
- [ ] Test class transfer between teachers

## Recommendations

Given the complexity:
1. **Phase 1 (DONE)**: Attendance isolation ✅  
2. **Phase 2 (NEXT)**: Seat position isolation
3. **Phase 3**: Grid settings isolation  
4. **Phase 4**: Full testing and migration

Would you like me to proceed with implementing seat positions isolation now?
This will require modifying the student data structure.
